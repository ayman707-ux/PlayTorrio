name: Build Multi-Platform

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install
      
    - name: Setup Windows Players
      run: |
        # Extract MPV from RAR file in repo
        if (Test-Path "mpv.rar") {
          Write-Host "Extracting mpv.rar..."
          7z x mpv.rar -y
          
          if (Test-Path "mpv/mpv.exe") {
            Write-Host "✓ MPV extracted successfully"
            Get-ChildItem mpv | Select-Object -First 5
          } else {
            Write-Host "Contents after extraction:"
            Get-ChildItem -Recurse | Select-Object -First 20
            Write-Host "✗ MPV extraction failed - mpv/mpv.exe not found!"
            exit 1
          }
        } elseif (Test-Path "mpv.zip") {
          Write-Host "Extracting mpv.zip..."
          Expand-Archive -Path "mpv.zip" -DestinationPath "mpv-temp" -Force
          
          # Check if files are in root or nested folder
          if (Test-Path "mpv-temp/mpv.exe") {
            Move-Item -Path "mpv-temp" -Destination "mpv" -Force
            Write-Host "✓ MPV extracted (root level)"
          } elseif (Test-Path "mpv-temp/mpv/mpv.exe") {
            Move-Item -Path "mpv-temp/mpv" -Destination "mpv" -Force
            Remove-Item "mpv-temp" -Recurse -Force
            Write-Host "✓ MPV extracted (nested folder)"
          } else {
            Write-Host "Contents of mpv-temp:"
            Get-ChildItem "mpv-temp" -Recurse | Select-Object -First 20
            Write-Host "✗ MPV extraction failed - mpv.exe not found!"
            exit 1
          }
        } else {
          Write-Host "✗ mpv.rar or mpv.zip not found in repo!"
          exit 1
        }
        
        # VLC extraction
        if (Test-Path "vlc.rar") {
          Write-Host "Extracting vlc.rar..."
          7z x vlc.rar -y
          
          if (Test-Path "VLC/VLCPortable.exe") {
            Write-Host "✓ VLC extracted successfully (VLCPortable.exe found)"
          } elseif (Test-Path "VLC/App/vlc/vlc.exe") {
            Write-Host "✓ VLC extracted successfully (vlc.exe found)"
          } else {
            Write-Host "Contents after VLC extraction:"
            Get-ChildItem -Recurse | Select-Object -First 20
            Write-Host "✗ VLC extraction failed - VLCPortable.exe or vlc.exe not found!"
            exit 1
          }
        } elseif (Test-Path "VLC/VLCPortable.exe") {
          Write-Host "✓ VLC already in repo (VLCPortable)"
        } elseif (Test-Path "VLC/App/vlc/vlc.exe") {
          Write-Host "✓ VLC already in repo"
        } else {
          Write-Host "⚠ VLC not found - continuing without it"
        }
      shell: pwsh
        
    - name: Verify Icons
      run: |
        if (!(Test-Path "build")) { mkdir build }
        if (Test-Path "icon.ico") {
          Copy-Item "icon.ico" "build/icon.ico" -Force
          Write-Host "✓ Using icon.ico"
        }
        if (Test-Path "icon.png") {
          Copy-Item "icon.png" "build/icon.png" -Force
          Write-Host "✓ Copied icon.png for Linux"
        }
      shell: pwsh
        
    - name: Build Windows Installer
      run: npm run build -- --win --publish always
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        
    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: |
          dist/*.exe
          dist/*.exe.blockmap
          dist/*.yml
        retention-days: 30

  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install
      
    - name: Setup MPV for Linux
      run: |
        # For Linux, skip MPV bundling - users install system-wide
        # The app will detect system MPV at /usr/bin/mpv automatically
        echo "✓ Linux build configured (users install mpv via: sudo apt install mpv)"
        
    - name: Verify Icons
      run: |
        mkdir -p build
        if [ -f "icon.png" ]; then
          cp icon.png build/icon.png
          echo "✓ Using icon.png"
        fi
        if [ -f "icon.ico" ]; then
          cp icon.ico build/icon.ico
          echo "✓ Copied icon.ico"
        fi
        
    - name: Build Linux Packages
      run: npm run build -- --linux --publish always
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        
    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-packages
        path: |
          dist/*.AppImage
          dist/*.deb
          dist/*.yml
        retention-days: 30

  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Prepare signing credentials (if provided)
      run: |
        if [ -n "${{ secrets.APPLE_API_KEY }}" ]; then
          echo "Setting up Apple signing credentials..."
          mkdir -p ~/private_keys
          echo "${{ secrets.APPLE_API_KEY }}" > ~/private_keys/AuthKey_${{ secrets.APPLE_API_KEY_ID }}.p8
          echo "✓ Apple API key written"
        else
          echo "No Apple API key secret set; skipping signing credentials."
        fi
      shell: bash

    - name: Export signing/notarization env (if present)
      run: |
        # Only export if secrets exist to avoid passing empty envs to electron-builder
        if [ -n "${{ secrets.CSC_LINK }}" ]; then
          echo "CSC_LINK is set"
          echo "CSC_LINK=${{ secrets.CSC_LINK }}" >> $GITHUB_ENV
        fi
        if [ -n "${{ secrets.CSC_KEY_PASSWORD }}" ]; then
          echo "CSC_KEY_PASSWORD set"
          echo "CSC_KEY_PASSWORD=${{ secrets.CSC_KEY_PASSWORD }}" >> $GITHUB_ENV
        fi
        if [ -n "${{ secrets.APPLE_TEAM_ID }}" ]; then
          echo "APPLE_TEAM_ID set"
          echo "APPLE_TEAM_ID=${{ secrets.APPLE_TEAM_ID }}" >> $GITHUB_ENV
        fi
        if [ -n "${{ secrets.APPLE_API_KEY }}" ]; then
          echo "APPLE API env set"
          echo "APPLE_API_KEY=${{ secrets.APPLE_API_KEY }}" >> $GITHUB_ENV
          echo "APPLE_API_KEY_ID=${{ secrets.APPLE_API_KEY_ID }}" >> $GITHUB_ENV
          echo "APPLE_API_ISSUER=${{ secrets.APPLE_API_ISSUER }}" >> $GITHUB_ENV
        fi
      shell: bash

    - name: Determine updater toggle (mac)
      run: |
        if [ -n "${{ secrets.APPLE_API_KEY }}" ] && [ -n "${{ secrets.CSC_LINK }}" ]; then
          echo "FORCE_ENABLE_UPDATER=1" >> $GITHUB_ENV
          echo "Enabling updater on macOS (secrets present)"
        else
          echo "FORCE_ENABLE_UPDATER=0" >> $GITHUB_ENV
          echo "Disabling updater on macOS (missing signing/notarization secrets)"
        fi
      shell: bash
        
    - name: Install dependencies
      run: npm install
      
    - name: Download MPV for macOS
      run: |
        # Download MPV portable
        curl -L https://laboratory.stolendata.net/~djinn/mpv_osx/mpv-latest.tar.gz -o mpv.tar.gz
        mkdir -p mpv
        tar -xzf mpv.tar.gz -C mpv
        # Verify MPV was extracted
        ls -la mpv/
        
    - name: Verify Icon
      run: |
        mkdir -p build
        if [ -f "icon.icns" ]; then
          cp icon.icns build/icon.icns
          echo "✓ Using existing icon.icns"
        elif [ -f "build/icon.icns" ]; then
          echo "✓ Icon already in build directory"
        else
          echo "Warning: icon.icns not found, using default Electron icon"
        fi
        
    - name: Build macOS DMG
      run: npm run build -- --mac --publish always
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        CSC_IDENTITY_AUTO_DISCOVERY: true
        FORCE_ENABLE_UPDATER: ${{ env.FORCE_ENABLE_UPDATER }}
    
    - name: Fix macOS Gatekeeper Issues
      run: |
        # Remove quarantine attributes from built app
        echo "Removing quarantine attributes to prevent 'damaged app' errors..."
        xattr -cr dist/mac*/PlayTorrio.app 2>/dev/null || true
        xattr -cr dist/mac-arm64*/PlayTorrio.app 2>/dev/null || true
        echo "✓ Quarantine attributes removed"

    - name: Staple notarization ticket (if signed)
      run: |
        if [ -n "${{ secrets.APPLE_API_KEY }}" ]; then
          echo "Attempting to staple notarization ticket..."
          for dmg in dist/*.dmg; do
            echo "Stapling $dmg"
            xcrun stapler staple "$dmg" || echo "Stapling failed (continuing)"
          done
          echo "Stapling step complete"
        else
          echo "No Apple API key secret set; skipping stapling."
        fi
        
    - name: Upload DMG artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-dmg
        path: |
          dist/*.dmg
          dist/*.dmg.blockmap
          dist/*mac*.yml
          MACOS_INSTALLATION.md
        retention-days: 30
