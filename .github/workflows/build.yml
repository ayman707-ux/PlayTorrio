name: Build Multi-Platform

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install
      
    - name: Download and Setup Windows Players
      run: |
        # Download MPV portable for Windows
        Write-Host "Downloading MPV for Windows..."
        Invoke-WebRequest -Uri "https://github.com/shinchiro/mpv-winbuild-cmake/releases/download/20241027/mpv-x86_64-20241027-git-3c1e1cf.7z" -OutFile "mpv.7z" -UserAgent "Mozilla/5.0"
        
        Write-Host "Extracting MPV..."
        7z x mpv.7z -y
        
        # Move extracted files to mpv folder
        if (Test-Path "mpv.com") {
          if (!(Test-Path "mpv")) { mkdir mpv }
          Move-Item -Path "*.exe" -Destination "mpv/" -Force
          Move-Item -Path "*.dll" -Destination "mpv/" -Force -ErrorAction SilentlyContinue
          Move-Item -Path "*.com" -Destination "mpv/" -Force -ErrorAction SilentlyContinue
          Move-Item -Path "doc" -Destination "mpv/" -Force -ErrorAction SilentlyContinue
          Write-Host "✓ MPV extracted and organized"
        }
        
        if (Test-Path "mpv/mpv.exe") {
          Write-Host "✓ MPV ready at mpv/mpv.exe"
        } else {
          Write-Host "✗ MPV download failed!"
          exit 1
        }
        
        # VLC should be in repo (or skip if not needed for Windows)
        if (Test-Path "VLC/App/vlc/vlc.exe") {
          Write-Host "✓ VLC found in repo"
        } else {
          Write-Host "⚠ VLC not in repo - continuing without it"
        }
      shell: pwsh
        
    - name: Verify Icons
      run: |
        if (!(Test-Path "build")) { mkdir build }
        if (Test-Path "icon.ico") {
          Copy-Item "icon.ico" "build/icon.ico" -Force
          Write-Host "✓ Using icon.ico"
        }
        if (Test-Path "icon.png") {
          Copy-Item "icon.png" "build/icon.png" -Force
          Write-Host "✓ Copied icon.png for Linux"
        }
      shell: pwsh
        
    - name: Build Windows Installer
      run: npm run build -- --win
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        
    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: |
          dist/*.exe
          dist/*.exe.blockmap
        retention-days: 30

  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install
      
    - name: Setup MPV for Linux
      run: |
        # For Linux, skip MPV bundling - users install system-wide
        # The app will detect system MPV at /usr/bin/mpv automatically
        echo "✓ Linux build configured (users install mpv via: sudo apt install mpv)"
        
    - name: Verify Icons
      run: |
        mkdir -p build
        if [ -f "icon.png" ]; then
          cp icon.png build/icon.png
          echo "✓ Using icon.png"
        fi
        if [ -f "icon.ico" ]; then
          cp icon.ico build/icon.ico
          echo "✓ Copied icon.ico"
        fi
        
    - name: Build Linux Packages
      run: npm run build -- --linux
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        
    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-packages
        path: |
          dist/*.AppImage
          dist/*.deb
        retention-days: 30

  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install
      
    - name: Download MPV for macOS
      run: |
        # Download MPV portable
        curl -L https://laboratory.stolendata.net/~djinn/mpv_osx/mpv-latest.tar.gz -o mpv.tar.gz
        mkdir -p mpv
        tar -xzf mpv.tar.gz -C mpv
        # Verify MPV was extracted
        ls -la mpv/
        
    - name: Verify Icon
      run: |
        mkdir -p build
        if [ -f "icon.icns" ]; then
          cp icon.icns build/icon.icns
          echo "✓ Using existing icon.icns"
        elif [ -f "build/icon.icns" ]; then
          echo "✓ Icon already in build directory"
        else
          echo "Warning: icon.icns not found, using default Electron icon"
        fi
        
    - name: Build macOS DMG
      run: npm run build -- --mac
      env:
        CSC_IDENTITY_AUTO_DISCOVERY: false
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
    
    - name: Fix macOS Gatekeeper Issues
      run: |
        # Remove quarantine attributes from built app
        echo "Removing quarantine attributes to prevent 'damaged app' errors..."
        xattr -cr dist/mac*/PlayTorrio.app 2>/dev/null || true
        xattr -cr dist/mac-arm64*/PlayTorrio.app 2>/dev/null || true
        echo "✓ Quarantine attributes removed"
        
    - name: Upload DMG artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-dmg
        path: |
          dist/*.dmg
          dist/*.dmg.blockmap
          MACOS_INSTALLATION.md
        retention-days: 30
