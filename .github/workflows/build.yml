name: Build Multi-Platform

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm install
      - name: Setup Windows Players
        run: |
          if (Test-Path "mpv.rar") { 7z x mpv.rar -y }
          elseif (Test-Path "mpv.zip") { Expand-Archive -Path mpv.zip -DestinationPath mpv-temp -Force }
          if (!(Test-Path "mpv/mpv.exe")) { Write-Host "MPV missing" }
          if (Test-Path "vlc.rar") { 7z x vlc.rar -y }
      - name: Verify Icons
        run: |
          if (!(Test-Path build)) { mkdir build }
          if (Test-Path icon.ico) { Copy-Item icon.ico build/icon.ico -Force }
      - name: Build Windows Installer
        run: npm run build -- --win --publish always
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm install
      - name: Prepare resources
        run: |
          mkdir -p mpv VLC build
          [ -f icon.png ] && cp icon.png build/icon.png || true
      - name: Build Linux Packages
        run: npm run build -- --linux --publish always
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      - name: Verify AppImage
        run: |
          set -e
          ls dist/*.AppImage
          chmod +x dist/*.AppImage
          echo "AppImage artifacts ready"

  build-macos-x64:
    runs-on: macos-13
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm install && npx electron-builder install-app-deps
      - name: Download MPV (x64)
        run: |
          curl -fL https://laboratory.stolendata.net/~djinn/mpv_osx/mpv-latest.tar.gz -o mpv.tar.gz || true
          mkdir -p mpv
          [ -f mpv.tar.gz ] && tar -xzf mpv.tar.gz -C mpv || true
      - name: Build macOS x64 DMG
        run: npm run build -- --mac --x64 --publish always
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
      - name: Strip quarantine
        run: |
          xattr -cr dist/*x64*/PlayTorrio.app || true

  build-macos-arm64:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm install && npx electron-builder install-app-deps
      - name: Download MPV (arm64)
        run: |
          curl -fL https://laboratory.stolendata.net/~djinn/mpv_osx/mpv-latest.tar.gz -o mpv.tar.gz || true
          mkdir -p mpv
          [ -f mpv.tar.gz ] && tar -xzf mpv.tar.gz -C mpv || true
      - name: Build macOS arm64 DMG
        run: npm run build -- --mac --arm64 --publish always
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
      - name: Strip quarantine
        run: |
          xattr -cr dist/*arm64*/PlayTorrio.app || true

  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    # Signing is disabled by request; skip all Apple signing/notarization steps
    - name: Disable mac updater and signing
      run: |
        echo "FORCE_ENABLE_UPDATER=0" >> $GITHUB_ENV
        echo "Skipping macOS signing and notarization"
      shell: bash
        
    - name: Install dependencies
      run: npm install
      
    - name: Download MPV for macOS
      run: |
        # Download MPV portable (with fallback and error handling)
        if ! curl -fL https://laboratory.stolendata.net/~djinn/mpv_osx/mpv-latest.tar.gz -o mpv.tar.gz; then
          echo "⚠ MPV download failed from primary source"
          # Try alternative community mirror
          if ! curl -fL https://nightly.link/IntersectRaven/mpv-appimage/workflows/build/master/mpv-x86_64.AppImage.zip -o mpv.zip; then
            echo "✗ All MPV download sources failed. Users will need system MPV (/Applications/mpv.app)"
            exit 0  # Don't fail the build, just skip MPV bundling
          fi
        fi

        mkdir -p mpv
        if [ -f mpv.tar.gz ]; then
          echo "✓ Extracting mpv.tar.gz..."
          tar -xzf mpv.tar.gz -C mpv || true
        elif [ -f mpv.zip ]; then
          echo "✓ Extracting mpv.zip..."
          unzip -o mpv.zip -d mpv || true
        fi

        # Normalize layout: ensure mpv/mpv.app exists at root
        if [ -d "mpv/mpv.app" ]; then
          echo "✓ mpv.app present at mpv/mpv.app"
        else
          found=$(find mpv -maxdepth 3 -name "mpv.app" | head -n 1)
          if [ -n "$found" ]; then
            echo "Moving $found to mpv/mpv.app"
            rm -rf mpv/mpv.app
            mv "$found" mpv/
          else
            echo "⚠ mpv.app not found after extraction; continuing without bundled MPV"
          fi
        fi

        # Ensure binary is executable if present
        if [ -f "mpv/mpv.app/Contents/MacOS/mpv" ]; then
          chmod +x "mpv/mpv.app/Contents/MacOS/mpv"
          echo "✓ Marked MPV binary as executable"
          ls -la "mpv/mpv.app/Contents/MacOS/mpv"
        fi
        
    - name: Verify Icon
      run: |
        mkdir -p build
        if [ -f "icon.icns" ]; then
          cp icon.icns build/icon.icns
          echo "✓ Using existing icon.icns"
        elif [ -f "build/icon.icns" ]; then
          echo "✓ Icon already in build directory"
        else
          echo "Warning: icon.icns not found, using default Electron icon"
        fi
        
    - name: Build macOS DMG (unsigned)
      run: npm run build -- --mac --publish always
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        CSC_IDENTITY_AUTO_DISCOVERY: false
        FORCE_ENABLE_UPDATER: ${{ env.FORCE_ENABLE_UPDATER }}
    
    - name: Fix macOS Gatekeeper Issues
      run: |
        # Remove quarantine attributes from built app
        echo "Removing quarantine attributes to prevent 'damaged app' errors..."
        xattr -cr dist/mac*/PlayTorrio.app 2>/dev/null || true
        xattr -cr dist/mac-arm64*/PlayTorrio.app 2>/dev/null || true
        echo "✓ Quarantine attributes removed"

